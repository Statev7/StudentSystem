@using StudentSystem.Services.Review.Models
@model DetailCourseViewModel

@{
	this.ViewData["Title"] = $"Details: {Model.Name}";
	var count = 0;

	var userId = this.User.GetId();
	this.ViewBag.CourseId = Model.Id;
}

@inject UserManager<ApplicationUser> userManager

<div class="text-center p-4" style="background-color: #F1F1F1">
	<h1>@Model.Name</h1>
	<h6>Start date: @Model.StartDate</h6>
</div>
<div class="container">
	<div class="shadow-box mt-5 mb-5">
		<div class="p-3 text-center">
			<h3>Lessons</h3>
			<hr />
		</div>
		<div class="container overflow-hidden">
			<div class="row gx-5 mb-3">
				@foreach (var lesson in Model.Lessons)
				{
					<div class="col-sm-12 col-md-6">
						<div onclick="displayLessonInformation(@lesson.Id)" style="cursor: pointer">
							<div class="p-2 mt-1 border" style="background-color: #f1f1f1;">
								<span class="lesson-title">@(++count). @lesson.Title</span>
							</div>
						</div>
						<div id="@lesson.Id" class="d-none p-2 mt-1 border">
							<div class="p-2">
								<p style="font-size: 18px; font-family: Verdana">
									@lesson.Title
								</p>
								<p>
									@{
										string[] stringSeparators = new string[] { "\r\n" };
										var splitedContent = @lesson.Content.Split(stringSeparators, StringSplitOptions.None);
									}
									<ul>
										@foreach (var contentLine in splitedContent)
										{
											<li>
												@contentLine
											</li>
										}
									</ul>
								</p>
								<p>
									Date: @lesson.Begining.ToString("dd MMMM", CultureInfo.InvariantCulture) (@lesson.Begining.DayOfWeek),
									from @lesson.Begining.ToString("HH:mm", CultureInfo.InvariantCulture) to 
									@lesson.End.ToString("HH:mm", CultureInfo.InvariantCulture)<span>.</span>
								</p>
								<p style="font-size: 18px; font-family: Verdana">
									Resources:
								</p>
								<p>
									@foreach (var resource in lesson.Resources)
									{
										<a href="@resource.ULR">@resource.Name</a>
									}
								</p>
							</div>
						</div>
					</div>
				}
			</div>
		</div>
	</div>
	@if (this.User.IsAdministrator())
	{
		<div class="text-center mb-3">
			<a asp-area="Trainings"
		   asp-controller="Courses"
		   asp-action="Update"
		   asp-route-id="@Model.Id"
		   class="btn btn-primary rounded-pill w-25 p-2">
				Update
			</a>
		</div>
	}
	<div class="text-center">
		<button id="show-information-btn" class="btn btn-primary rounded-pill mb-3 w-25 p-2">Show More</button>
	</div>
	<div id="information-box" class="d-none">
		<div class="shadow-box offset-md-1 col-sm col-md-10 mb-5 p-3">
			<h5>Description</h5>
			<div>
				@Model.Description
			</div>
		</div>
		<div class="shadow-box offset-md-1 col-sm col-md-10 mb-5 p-3">
			<h5 class="mb-3">Reviews</h5>
			<div>
				@foreach (var review in Model.Reviews)
				{
					<div class="card mb-4">
						<div class="card-body">
							<p>@review.Content</p>

							<div class="d-flex justify-content-between">
								<div class="d-flex flex-row align-items-center">
									<img src="@review.UserImageIRL" alt="avatar" width="25"
									 height="25" />
									<p class="small pl-2 mb-0 ms-2">@review.Username</p>
								</div>
								<div class="d-flex flex-row align-items-center">
									@if (review.UserId == this.User.GetId() || this.User.IsInRole(GlobalConstants.ADMIN_ROLE))
									{
										<div>
											<a class="options-bar"
											   asp-controller="CourseReviews"
											   asp-action="Update"
											   asp-route-id=@review.Id
											   asp-route-courseId="@Model.Id">Update
										   </a>
											<span>|</span>
											<a class="options-bar"
											  asp-controller="CourseReviews"
											   asp-action="Delete"
											   asp-route-reviewId=@review.Id
											   asp-route-courseId="@Model.Id">Delete
											</a>
										</div>
									}
								</div>
							</div>
						</div>
					</div>
				}
			</div>
		</div>
	</div>
	<div class="text-center">
		@if (!this.User.IsUserInCourse(userManager, Model.Id, userId))
		{
			<a 
				asp-area="Trainings"
				asp-controller="RegisterForCourse"
				asp-action="Apply"
				asp-route-id="@Model.Id"
				class="btn btn-primary rounded-pill w-25 p-2">
				Register for course
			</a>
		}
		else if (this.User.IsUserInCourse(userManager, Model.Id, userId) || this.User.IsAdministrator())
		{
			<div class="text-center mb-3">
				<button id="show-review-form-btn" class="btn btn-primary rounded-pill mb-3 w-25 p-2">Leave a review</button>
			</div>
			<div id="review-form" class="d-none offset-md-1 col-sm col-md-10">
				<div>
					<form 
						asp-area="Trainings"
						asp-controller="CourseReviews" 
						asp-action="Create" 
						asp-route-courseId="@Model.Id" method="post">
						<div asp-validation-summary="ModelOnly" class="text-danger"></div>
						<div class="form-group">
							<textarea asp-for="@Model.Content" class="form-control" style="height: 200px"></textarea>
							<span asp-validation-for="@Model.Content" class="text-danger"></span>
						</div>
						<div class="form-group text-center">
							<input type="submit" value="Submit" class="btn btn-primary w-25 rounded-pill" />
						</div>
					</form>
				</div>
			</div>
		}
	</div>
</div>

@section Scripts{

	@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

	<script>

		function displayLessonInformation(id){
			let lessonDiv = document.getElementById(id);

			if(lessonDiv.classList.contains('d-none')){
				lessonDiv.classList.remove('d-none');
			}
			else{
				lessonDiv.classList.add('d-none');
			}
		}

	</script>

	<script>
		let informationBtn = document.getElementById('show-information-btn');
		let reviewBtn = document.getElementById('show-review-form-btn');

		informationBtn.addEventListener('click', () => someFunc('information-box'));
		reviewBtn.addEventListener('click', () => someFunc('review-form'));

		function someFunc(elementId) {

			let box = document.getElementById(elementId);

			if (box.classList.contains('d-none')) {
				box.classList.remove('d-none');
				switch (elementId) {
					case 'information-box': informationBtn.innerHTML = 'Show Less'; break;
				}
			}
			else {
				box.classList.add('d-none');
				switch (elementId) {
					case 'information-box': informationBtn.innerHTML = 'Show More'; break;
				}
			}
		}
	</script>
}